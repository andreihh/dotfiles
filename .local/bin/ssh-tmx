#!/bin/sh
#
# Connects to the selected host via SSH and starts `tmux` in a login shell.
#
# Dependencies:
# - Client: `ssh`, `fzf`, `bash`
# - Host: `tmux`

# Exit if any command fails.
set -e

known_hosts="$(cut < "${HOME}/.ssh/known_hosts" -d ' ' -f 1)"
[ -z "${known_hosts}" ] && echo "No known hosts found!" 1>&2 && exit 1

host="$(echo "${known_hosts}" | fzf-tmux --select-1 --prompt='Hosts> ')"

# Fetch the user's default login shell on the host to load environment properly.
# shellcheck disable=SC2016
cmd='"$(getent passwd "${USER}" | cut -d : -f 7)" -lc tmx'

ssh -t "$@" "${host}" "${cmd}"

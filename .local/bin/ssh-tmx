#!/bin/sh
#
# Connects to the host selected with `fzf` via SSH and starts `tmx` in a login
# shell.
#
# Dependencies:
# - Client: `ssh`, `fzf-tmux` (requires `fzf` and `bash`)
# - Host: `tmux`

# Exit if any command fails.
set -e

hosts="$(cut < "${HOME}/.ssh/known_hosts" -d ' ' -f 1)"
if [ -z "${hosts}" ]; then
  echo "No known hosts found!" 2>&1
  exit 1
elif [ "$(echo "${hosts}" | wc -l)" = 1 ]; then
  host="${hosts}"
else
  host="$(echo "${hosts}" | fzf-tmux)"
fi

# Fetch the user's default login shell on the host to ensure the environment is
# loaded properly.
# shellcheck disable=SC2016
ssh -t "$@" "${host}" '"$(getent passwd "${USER}" | cut -d : -f 7)" -lc tmx'

#!/bin/bash -e
#
# Configures the color scheme for terminal apps (`tmux`, `vim`, `nvim`, etc.):
# - Exports the system-wide `${COLORSCHEME}` environment variable
# - Updates terminal configs that don't support dynamic loading of color schemes

[[ $# -ne 1 ]] && echo "Usage $0 COLORSCHEME" && exit 1

readonly CONFIG_HOME="${XDG_CONFIG_HOME:-${HOME}/.config}"
readonly COLORSCHEME="$1"

echo "Configuring \`\${COLORSCHEME}\` environment variable..."
cat << EOF > "${CONFIG_HOME}/profile.d/00-colorscheme.sh"
# colorscheme.sh: auto-generated to set the color scheme environment variable.
#
# Regenerate with the \`colorscheme\` command.

export COLORSCHEME="${COLORSCHEME}"
EOF

# X11 config is not XDG-compliant and cannot import dynamic files.
readonly XRESOURCES_SH="${CONFIG_HOME}/profile.d/10-xresources.sh"

command -v xterm > /dev/null 2>&1 \
  && echo "Seting up script to load X11 resources..." \
  && cat << EOF > "${XRESOURCES_SH}"
# xresources.sh: auto-generated to load X11 resources and color scheme.
#
# Regenerate or clean up with the \`colorscheme\` command.

xrdb -merge "\${CONFIG_HOME}/X11/Xresources"
xrdb -merge "\${CONFIG_HOME}/X11/Xcolors/\${COLORSCHEME}.Xresources"
EOF

# Clean up X11 resources loading script if `xterm` is not installed.
command -v xterm > /dev/null 2>&1 || rm "${XRESOURCES_SH}"

# Ghostty config cannot set dynamic themes.
command -v ghostty > /dev/null 2>&1 \
  && echo "Setting up Ghostty color scheme config..." \
  && cat << EOF > "${CONFIG_HOME}/ghostty/colorscheme"
# colorscheme: auto-generated to set the Ghostty theme.
#
# Regenerate with the \`colorscheme\` command.

theme = ${COLORSCHEME}
EOF

# Alacritty config cannot import dynamic files.
command -v alacritty > /dev/null 2>&1 \
  && echo "Setting up Alacritty color scheme config..." \
  && cat << EOF > "${CONFIG_HOME}/alacritty/colorscheme.toml"
# colorscheme.toml: auto-generated from \`\${COLORSCHEME}\`.

[general]
import = ["themes/${COLORSCHEME}.toml"]
EOF

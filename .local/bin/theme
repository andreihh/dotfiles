#!/bin/bash -e
#
# Configures the system theme.
#
# Supported systems: Debian, Ubuntu, Fedora, RHEL

readonly CONFIG_HOME="${XDG_CONFIG_HOME:-${HOME}/.config}"
readonly DATA_HOME="${XDG_DATA_HOME:-${HOME}/.local/share}"

shopt -s nocasematch
case "${OSTYPE}" in
  linux*)
    . /etc/os-release
    case "${ID}" in
      debian | ubuntu | fedora | rhel) OS="${ID}" ;;
      *) "System '${ID}' not supported!" && exit 1 ;;
    esac
    ;;
  darwin*) OS='macos' ;;
  *) echo "System '${OSTYPE}' not supported!" && exit 1 ;;
esac
shopt -u nocasematch
readonly OS

usage() {
  cat << EOF
Usage: $0 THEME

Configures the system theme, which must be one of:
  catppuccin-macchiato
  catppuccin-frappe
EOF
}

[[ $# -ne 1 ]] && usage && exit 1

theme="$1"
case "${theme}" in
  catppuccin-macchiatoc)
    vim_theme='catppuccin_macchiato'
    fzf_theme='catppuccin-fzf-macchiato'
    bat_theme='Catppuccin Macchiato'
    gtk_theme_installer=(
      "${DATA_HOME}/catppuccin/gtk/themes/install.sh"
      --dest "${DATA_HOME}/themes"
      --libadwaita --tweaks outline --tweaks macchiato
    )

    dconf_settings="$(
      cat << EOF
[org/gnome/shell/extensions/user-theme]
name='Catppuccin-Dark-Macchiato'

[org/gnome/desktop/background]
picture-uri='file://${DATA_HOME}/wallpapers/${OS}-catppuccin-latte.png'
picture-uri-dark='file://${DATA_HOME}/wallpapers/${OS}-catppuccin-macchiato.png'

[org/gnome/desktop/interface]
accent-color='blue'
color-scheme='prefer-dark'
cursor-theme='catppuccin-macchiato-dark-cursors'
gtk-theme='Catppuccin-Dark-Macchiato'
icon-theme='Adwaita'
EOF
    )"
    ;;

  catppuccin-frappe)
    vim_theme='catppuccin_frappe'
    fzf_theme='catppuccin-fzf-frappe'
    bat_theme='Catppuccin Frappe'
    gtk_theme_installer=(
      "${DATA_HOME}/catppuccin/gtk/themes/install.sh"
      --dest "${DATA_HOME}/themes"
      --libadwaita --tweaks outline --tweaks frappe
    )

    dconf_settings="$(
      cat << EOF
[org/gnome/shell/extensions/user-theme]
name='Catppuccin-Dark-Frappe'

[org/gnome/desktop/background]
picture-uri='file://${DATA_HOME}/wallpapers/${ID}-catppuccin-latte.png'
picture-uri-dark='file://${DATA_HOME}/wallpapers/${ID}-catppuccin-frappe.png'

[org/gnome/desktop/interface]
accent-color='blue'
color-scheme='prefer-dark'
cursor-theme='catppuccin-frappe-dark-cursors'
gtk-theme='Catppuccin-Dark-Frappe'
icon-theme='Adwaita'
EOF
    )"
    ;;

  *) usage && exit 1 ;;
esac

echo "Configuring Alacritty theme..."
cat << EOF > "${CONFIG_HOME}/alacritty/theme.toml"
# theme: configures Alacritty theme.
#
# Alacritty config cannot import dynamic files.

[general]
import = ["themes/${alacritty_theme:-${theme}}.toml"]
EOF

echo "Configuring Ghostty theme..."
cat << EOF > "${CONFIG_HOME}/ghostty/theme"
# theme: configures Ghostty theme.
#
# Ghostty config cannot set dynamic themes.

theme = "${ghostty_theme:-${theme}}"
EOF

echo "Configuring shell theme..."
cat << EOF > "${CONFIG_HOME}/profile.d/10-theme.sh"
# theme.sh: configures shell theme.
#
# shellcheck shell=sh

export TMUX_THEME='${tmux_theme:-${theme}}'
export NVIM_THEME='${nvim_theme:-${theme}}'
export VIM_THEME='${vim_theme:-${theme}}'
. "${CONFIG_HOME}/fzf/themes/${fzf_theme:-${theme}}.sh"
export BAT_THEME='${bat_theme:-${theme}}'
command -v kvantummanager > /dev/null 2>&1 && export QT_STYLE_OVERRIDE='kvantum'
EOF

echo "Configuring GTK theme..."
"${gtk_theme_installer[@]}"

command -v gnome-shell &> /dev/null \
  && echo "Configuring GNOME theme..." \
  && dconf load / <<< "${dconf_settings}"
